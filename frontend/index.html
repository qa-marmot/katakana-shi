<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã‚«ã‚¿ã‚«ãƒŠãƒ¼ã‚· - ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç‰ˆ</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef, useCallback } = React;

      const WIN_SCORE = 10;
      const MAX_ATTEMPTS = 2;

      function useTimer(timerEnd) {
        const [remaining, setRemaining] = useState(0);

        useEffect(() => {
          if (!timerEnd) return;
          const tick = () => {
            const diff = Math.max(0, Math.ceil(timerEnd - Date.now() / 1000));
            setRemaining(diff);
          };
          tick();
          const id = setInterval(tick, 500);
          return () => clearInterval(id);
        }, [timerEnd]);

        return remaining;
      }

      function TimerBar({ remaining }) {
        const pct = Math.min(100, (remaining / 180) * 100);
        const color = remaining > 60 ? "#4caf50" : remaining > 30 ? "#ff9800" : "#f44336";
        return (
          <div style={{ marginBottom: "20px" }}>
            <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "6px" }}>
              <span style={{ fontWeight: 600, color: remaining <= 30 ? "#f44336" : "#333" }}>
                â± æ®‹ã‚Šæ™‚é–“
              </span>
              <span style={{
                fontWeight: "bold",
                fontSize: "20px",
                color: remaining <= 30 ? "#f44336" : "#333",
                animation: remaining <= 10 ? "pulse 0.5s infinite" : "none",
              }}>
                {Math.floor(remaining / 60)}:{String(remaining % 60).padStart(2, "0")}
              </span>
            </div>
            <div style={{ background: "#e0e0e0", borderRadius: "8px", height: "12px", overflow: "hidden" }}>
              <div style={{
                width: `${pct}%`,
                height: "100%",
                background: color,
                borderRadius: "8px",
                transition: "width 0.5s linear, background 0.5s",
              }} />
            </div>
          </div>
        );
      }

      function App() {
        const [screen, setScreen] = useState("join");
        const [roomId, setRoomId] = useState("");
        const [userName, setUserName] = useState("");
        const [gameState, setGameState] = useState(null);
        const [ws, setWs] = useState(null);
        const [chatMessages, setChatMessages] = useState([]);
        const [chatInput, setChatInput] = useState("");
        const [connected, setConnected] = useState(false);
        const [answerInput, setAnswerInput] = useState("");
        const [answerFeedback, setAnswerFeedback] = useState(null);
        const [notification, setNotification] = useState(null);
        const wsRef = useRef(null);
        const chatEndRef = useRef(null);

        const BACKEND_URL = "katakana-shi.onrender.com";
        const WS_URL =
          window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1"
            ? "ws://localhost:8000"
            : `wss://${BACKEND_URL}`;

        const showNotification = (msg, type = "info") => {
          setNotification({ msg, type });
          setTimeout(() => setNotification(null), 3500);
        };

        const connectWebSocket = () => {
          if (!roomId || !userName) return;
          const websocket = new WebSocket(`${WS_URL}/ws/${roomId}/${userName}`);
          wsRef.current = websocket;

          websocket.onopen = () => { setConnected(true); };

          websocket.onmessage = (event) => {
            const message = JSON.parse(event.data);

            if (message.type === "state_update") {
              setGameState(message.data);
              setAnswerFeedback(null);
            } else if (message.type === "chat") {
              setChatMessages(prev => [...prev, message.data]);
              if (message.data.penalty) {
                showNotification(`âš ï¸ ${message.data.user}ã•ã‚“ãŒã‚«ã‚¿ã‚«ãƒŠã‚’ä½¿ã„ã¾ã—ãŸï¼ -1pt`, "danger");
              }
            } else if (message.type === "answer_result") {
              setAnswerFeedback(message.data);
            } else if (message.type === "correct_answer") {
              showNotification(`ğŸ‰ ${message.data.answerer}ã•ã‚“ãŒæ­£è§£ï¼ã€Œ${message.data.word}ã€`, "success");
              setAnswerInput("");
              setAnswerFeedback(null);
            } else if (message.type === "time_up") {
              showNotification("â° æ™‚é–“åˆ‡ã‚Œï¼æ¬¡ã®å‡ºé¡Œè€…ã¸", "warning");
              setGameState(message.data);
              setAnswerInput("");
              setAnswerFeedback(null);
            } else if (message.type === "all_attempts_used") {
              showNotification(`ğŸ˜… å…¨å“¡ã®è§£ç­”ãƒãƒ£ãƒ³ã‚¹çµ‚äº†ã€‚ãŠé¡Œã¯ã€Œ${message.data.word}ã€ã§ã—ãŸ`, "warning");
              setAnswerInput("");
              setAnswerFeedback(null);
            } else if (message.type === "game_over") {
              setGameState(message.data);
            }
          };

          websocket.onclose = () => { setConnected(false); };
          websocket.onerror = () => {};
          setWs(websocket);
        };

        useEffect(() => {
          if (screen === "game") connectWebSocket();
          return () => { if (wsRef.current) wsRef.current.close(); };
        }, [screen]);

        useEffect(() => {
          if (chatEndRef.current) {
            chatEndRef.current.scrollIntoView({ behavior: "smooth" });
          }
        }, [chatMessages]);

        const handleJoinRoom = (e) => {
          e.preventDefault();
          if (roomId && userName) setScreen("game");
        };

        const sendMessage = (payload) => {
          const socket = wsRef.current;
          if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify(payload));
          }
        };

        const handleSendChat = (e) => {
          e.preventDefault();
          if (!chatInput.trim()) return;
          sendMessage({ type: "chat", message: chatInput });
          setChatInput("");
        };

        const handleSubmitAnswer = (e) => {
          e.preventDefault();
          if (!answerInput.trim()) return;
          sendMessage({ type: "submit_answer", answer: answerInput.trim() });
        };

        const remaining = useTimer(gameState?.timer_end);
        const myAttempts = gameState?.answer_attempts?.[userName] ?? 0;
        const attemptsLeft = MAX_ATTEMPTS - myAttempts;

        // ---- JOIN SCREEN ----
        if (screen === "join") {
          return (
            <div className="container">
              <div className="card">
                <h1>ğŸ® ã‚«ã‚¿ã‚«ãƒŠãƒ¼ã‚·</h1>
                <p className="subtitle">ã‚«ã‚¿ã‚«ãƒŠã‚’ä½¿ã‚ãšã«ãŠé¡Œã‚’èª¬æ˜ã—ã‚ˆã†!</p>
                <form onSubmit={handleJoinRoom}>
                  <div className="input-group">
                    <label>ãƒ«ãƒ¼ãƒ ID</label>
                    <input type="text" placeholder="ä¾‹: room123" value={roomId}
                      onChange={e => setRoomId(e.target.value)} required />
                  </div>
                  <div className="input-group">
                    <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                    <input type="text" placeholder="ä¾‹: ãŸã‚ã†" value={userName}
                      onChange={e => setUserName(e.target.value)} required />
                  </div>
                  <button type="submit">ãƒ«ãƒ¼ãƒ ã«å‚åŠ </button>
                </form>
              </div>
            </div>
          );
        }

        if (!gameState) {
          return (
            <div className="container"><div className="card">
              <div className="status">æ¥ç¶šä¸­...</div>
            </div></div>
          );
        }

        // ---- GAME OVER SCREEN ----
        if (gameState.game_over) {
          const isWinner = gameState.winner === userName;
          const sorted = [...gameState.users].sort(
            (a, b) => (gameState.scores[b] || 0) - (gameState.scores[a] || 0)
          );
          return (
            <div className="container">
              <div className="card" style={{ textAlign: "center" }}>
                <div style={{ fontSize: "80px", marginBottom: "10px" }}>
                  {isWinner ? "ğŸ†" : "ğŸ®"}
                </div>
                <h1 style={{ fontSize: "2em", marginBottom: "10px" }}>
                  {isWinner ? "ã‚ãªãŸã®å‹åˆ©ï¼" : `${gameState.winner}ã•ã‚“ã®å‹åˆ©ï¼`}
                </h1>
                <p className="subtitle">å…ˆã«{WIN_SCORE}ãƒã‚¤ãƒ³ãƒˆç²å¾—ï¼</p>
                <div className="users-list" style={{ marginTop: "30px" }}>
                  {sorted.map((user, i) => (
                    <div key={user} className={`user-card ${i === 0 ? "presenter" : ""}`}>
                      <div className="user-name">{i === 0 ? "ğŸ† " : ""}{user}</div>
                      <div className="user-score">{gameState.scores[user] || 0} pt</div>
                    </div>
                  ))}
                </div>
                <button style={{ marginTop: "30px" }} onClick={() => {
                  if (wsRef.current) wsRef.current.close();
                  setScreen("join");
                  setGameState(null);
                  setChatMessages([]);
                }}>
                  ğŸ  ãƒ­ãƒ“ãƒ¼ã¸æˆ»ã‚‹
                </button>
              </div>
            </div>
          );
        }

        // ---- GAME SCREEN ----
        const currentPresenter = gameState.users[gameState.presenter_index];
        const isPresenter = currentPresenter === userName;
        const sorted = [...gameState.users].sort(
          (a, b) => (gameState.scores[b] || 0) - (gameState.scores[a] || 0)
        );

        return (
          <div className="container">
            {/* é€šçŸ¥ãƒãƒŠãƒ¼ */}
            {notification && (
              <div className={`notification notification-${notification.type}`}>
                {notification.msg}
              </div>
            )}

            <div className="card">
              <h1>ğŸ® ã‚«ã‚¿ã‚«ãƒŠãƒ¼ã‚·</h1>
              <p className="subtitle">ãƒ«ãƒ¼ãƒ : {roomId} | ã‚ãªãŸ: {userName}</p>

              {/* ã‚¿ã‚¤ãƒãƒ¼ */}
              <TimerBar remaining={remaining} />

              {/* å‡ºé¡Œè€…æƒ…å ± */}
              <div className="presenter-info">
                <div className="presenter-label">ç¾åœ¨ã®å‡ºé¡Œè€…</div>
                <div className="presenter-name">ğŸ‘‘ {currentPresenter}</div>
              </div>

              {/* ãŠé¡Œè¡¨ç¤º */}
              {isPresenter ? (
                <div className="word-display">
                  <div className="word-label">ã‚ãªãŸã®ãŠé¡Œ</div>
                  <div className="word">{gameState.current_word}</div>
                  <div style={{ marginTop: "16px", fontSize: "14px", opacity: 0.85 }}>
                    âš ï¸ ã‚«ã‚¿ã‚«ãƒŠã‚’ä½¿ã†ã¨ -1ptï¼ãƒãƒ£ãƒƒãƒˆã§èª¬æ˜ã—ã‚ˆã†
                  </div>
                </div>
              ) : (
                <div className="word-display" style={{ background: "linear-gradient(135deg, #43cea2 0%, #185a9d 100%)" }}>
                  <div className="word">â“</div>
                  <div style={{ marginTop: "16px", fontSize: "18px", opacity: 0.9 }}>
                    {currentPresenter}ã•ã‚“ãŒèª¬æ˜ä¸­...
                  </div>
                </div>
              )}

              {/* è§£ç­”ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆå‡ºé¡Œè€…ä»¥å¤–ï¼‰ */}
              {!isPresenter && (
                <div className="answer-box">
                  <h3>ğŸ’¡ è§£ç­”ï¼ˆæ®‹ã‚Š{attemptsLeft}å›ï¼‰</h3>
                  {attemptsLeft > 0 ? (
                    <form onSubmit={handleSubmitAnswer} style={{ display: "flex", gap: "10px", marginTop: "10px" }}>
                      <input
                        type="text"
                        placeholder="ç­”ãˆã‚’å…¥åŠ›..."
                        value={answerInput}
                        onChange={e => setAnswerInput(e.target.value)}
                        style={{ flex: 1 }}
                      />
                      <button type="submit" style={{ width: "auto", padding: "12px 20px" }}>
                        è§£ç­”
                      </button>
                    </form>
                  ) : (
                    <div className="check-result danger" style={{ marginTop: "10px" }}>
                      è§£ç­”ãƒãƒ£ãƒ³ã‚¹ã‚’ä½¿ã„åˆ‡ã‚Šã¾ã—ãŸ
                    </div>
                  )}
                  {answerFeedback && (
                    <div className={`check-result ${answerFeedback.correct ? "safe" : "danger"}`} style={{ marginTop: "10px" }}>
                      {answerFeedback.message}
                    </div>
                  )}
                </div>
              )}

              {/* ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ */}
              <h3 style={{ marginTop: "24px", marginBottom: "12px" }}>
                ğŸ… ã‚¹ã‚³ã‚¢ï¼ˆå…ˆã«{WIN_SCORE}ptã§å‹åˆ©ï¼‰
              </h3>
              <div className="users-list">
                {sorted.map((user) => {
                  const score = gameState.scores[user] || 0;
                  const pct = Math.min(100, (score / WIN_SCORE) * 100);
                  return (
                    <div key={user} className={`user-card ${user === currentPresenter ? "presenter" : ""}`}>
                      <div className="user-name">
                        {user === currentPresenter ? "ğŸ‘‘ " : ""}{user}
                        {user === userName ? " (ã‚ãªãŸ)" : ""}
                      </div>
                      <div className="score-bar-wrap">
                        <div className="score-bar" style={{ width: `${pct}%` }} />
                      </div>
                      <div className="user-score">{score} / {WIN_SCORE} pt</div>
                    </div>
                  );
                })}
              </div>

              {/* ãƒãƒ£ãƒƒãƒˆ */}
              <div style={{ marginTop: "24px" }}>
                <h3 style={{ marginBottom: "10px" }}>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ {isPresenter && <span style={{ fontSize: "13px", color: "#e53935", fontWeight: "normal" }}>ï¼ˆã‚«ã‚¿ã‚«ãƒŠä½¿ç”¨ã§-1ptï¼ï¼‰</span>}</h3>
                <div className="chat-area">
                  {chatMessages.map((msg, i) => (
                    <div key={i} className={`chat-message ${msg.penalty ? "chat-penalty" : ""}`}>
                      <span className="chat-user">{msg.user}:</span>
                      <span>{msg.message}</span>
                      {msg.penalty && <span className="penalty-badge">âš ï¸ -1pt</span>}
                    </div>
                  ))}
                  <div ref={chatEndRef} />
                </div>
                <form onSubmit={handleSendChat} style={{ marginTop: "10px" }}>
                  <div style={{ display: "flex", gap: "10px" }}>
                    <input
                      type="text"
                      placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
                      value={chatInput}
                      onChange={e => setChatInput(e.target.value)}
                      style={{ flex: 1 }}
                    />
                    <button type="submit" style={{ width: "auto", padding: "12px 20px" }}>
                      é€ä¿¡
                    </button>
                  </div>
                </form>
              </div>

              {/* é€€å‡º */}
              <button className="secondary-btn" style={{ marginTop: "20px" }} onClick={() => {
                if (wsRef.current) wsRef.current.close();
                setScreen("join");
                setGameState(null);
                setChatMessages([]);
              }}>
                ğŸšª é€€å‡º
              </button>

              <div className="status">{connected ? "ğŸŸ¢ æ¥ç¶šä¸­" : "ğŸ”´ åˆ‡æ–­"}</div>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>