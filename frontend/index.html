<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ã‚¿ã‚«ãƒŠãƒ¼ã‚· - ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç‰ˆ</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [screen, setScreen] = useState('join'); // 'join' or 'game'
            const [roomId, setRoomId] = useState('');
            const [userName, setUserName] = useState('');
            const [gameState, setGameState] = useState(null);
            const [ws, setWs] = useState(null);
            const [checkText, setCheckText] = useState('');
            const [checkResult, setCheckResult] = useState(null);
            const [chatMessages, setChatMessages] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [connected, setConnected] = useState(false);

            // WebSocketæ¥ç¶šURLï¼ˆç’°å¢ƒã«å¿œã˜ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰
            // ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ: ws://localhost:8000
            // æœ¬ç•ªç’°å¢ƒï¼ˆHTTPSã®å ´åˆï¼‰: wss://your-backend.onrender.com
            const WS_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? 'ws://localhost:8000' 
                : `wss://${window.location.hostname}`; // æœ¬ç•ªç’°å¢ƒã®å ´åˆã¯wss://ã‚’ä½¿ç”¨

            const connectWebSocket = () => {
                if (!roomId || !userName) return;

                const websocket = new WebSocket(`${WS_URL}/ws/${roomId}/${userName}`);

                websocket.onopen = () => {
                    console.log('WebSocketæ¥ç¶šæˆåŠŸ');
                    setConnected(true);
                };

                websocket.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    
                    if (message.type === 'state_update') {
                        setGameState(message.data);
                    } else if (message.type === 'katakana_check_result') {
                        setCheckResult(message.data);
                    } else if (message.type === 'chat') {
                        setChatMessages(prev => [...prev, message.data]);
                    }
                };

                websocket.onclose = () => {
                    console.log('WebSocketæ¥ç¶šçµ‚äº†');
                    setConnected(false);
                };

                websocket.onerror = (error) => {
                    console.error('WebSocket ã‚¨ãƒ©ãƒ¼:', error);
                };

                setWs(websocket);
            };

            useEffect(() => {
                if (screen === 'game') {
                    connectWebSocket();
                }

                return () => {
                    if (ws) {
                        ws.close();
                    }
                };
            }, [screen]);

            const handleJoinRoom = (e) => {
                e.preventDefault();
                if (roomId && userName) {
                    setScreen('game');
                }
            };

            const handleNextWord = () => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'next_word',
                        winner: userName
                    }));
                }
            };

            const handleCheckKatakana = () => {
                if (ws && ws.readyState === WebSocket.OPEN && checkText) {
                    ws.send(JSON.stringify({
                        type: 'check_katakana',
                        text: checkText
                    }));
                }
            };

            const handleSendChat = (e) => {
                e.preventDefault();
                if (ws && ws.readyState === WebSocket.OPEN && chatInput.trim()) {
                    ws.send(JSON.stringify({
                        type: 'chat',
                        message: chatInput
                    }));
                    setChatInput('');
                }
            };

            if (screen === 'join') {
                return (
                    <div className="container">
                        <div className="card">
                            <h1>ğŸ® ã‚«ã‚¿ã‚«ãƒŠãƒ¼ã‚·</h1>
                            <p className="subtitle">ã‚«ã‚¿ã‚«ãƒŠã‚’ä½¿ã‚ãšã«ãŠé¡Œã‚’èª¬æ˜ã—ã‚ˆã†!</p>
                            
                            <form onSubmit={handleJoinRoom}>
                                <div className="input-group">
                                    <label>ãƒ«ãƒ¼ãƒ ID</label>
                                    <input
                                        type="text"
                                        placeholder="ä¾‹: room123"
                                        value={roomId}
                                        onChange={(e) => setRoomId(e.target.value)}
                                        required
                                    />
                                </div>
                                
                                <div className="input-group">
                                    <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                                    <input
                                        type="text"
                                        placeholder="ä¾‹: ãŸã‚ã†"
                                        value={userName}
                                        onChange={(e) => setUserName(e.target.value)}
                                        required
                                    />
                                </div>
                                
                                <button type="submit">ãƒ«ãƒ¼ãƒ ã«å‚åŠ </button>
                            </form>
                        </div>
                    </div>
                );
            }

            if (!gameState) {
                return (
                    <div className="container">
                        <div className="card">
                            <div className="status">æ¥ç¶šä¸­...</div>
                        </div>
                    </div>
                );
            }

            const currentPresenter = gameState.users[gameState.presenter_index];
            const isPresenter = currentPresenter === userName;

            return (
                <div className="container">
                    <div className="card">
                        <h1>ğŸ® ã‚«ã‚¿ã‚«ãƒŠãƒ¼ã‚·</h1>
                        <p className="subtitle">ãƒ«ãƒ¼ãƒ : {roomId} | ã‚ãªãŸ: {userName}</p>
                        
                        <div className="presenter-info">
                            <div className="presenter-label">ç¾åœ¨ã®å‡ºé¡Œè€…</div>
                            <div className="presenter-name">ğŸ‘¤ {currentPresenter}</div>
                        </div>

                        {isPresenter && (
                            <div className="word-display">
                                <div className="word-label">ã‚ãªãŸã®ãŠé¡Œ</div>
                                <div className="word">{gameState.current_word}</div>
                                <div style={{marginTop: '20px', fontSize: '14px', opacity: 0.9}}>
                                    âš ï¸ ã‚«ã‚¿ã‚«ãƒŠã‚’ä½¿ã‚ãšã«èª¬æ˜ã—ã¦ãã ã•ã„ï¼
                                </div>
                            </div>
                        )}

                        {!isPresenter && (
                            <div className="word-display">
                                <div className="word">â“</div>
                                <div style={{marginTop: '20px', fontSize: '18px', opacity: 0.9}}>
                                    {currentPresenter}ã•ã‚“ãŒèª¬æ˜ä¸­...
                                </div>
                            </div>
                        )}

                        <h3 style={{marginTop: '30px', marginBottom: '15px'}}>å‚åŠ è€…ã¨ã‚¹ã‚³ã‚¢</h3>
                        <div className="users-list">
                            {gameState.users.map((user, index) => (
                                <div 
                                    key={user} 
                                    className={`user-card ${index === gameState.presenter_index ? 'presenter' : ''}`}
                                >
                                    <div className="user-name">
                                        {index === gameState.presenter_index && 'ğŸ‘‘ '}
                                        {user}
                                    </div>
                                    <div className="user-score">
                                        {gameState.scores[user] || 0} pt
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="button-group">
                            <button onClick={handleNextWord}>
                                âœ… æ­£è§£ï¼æ¬¡ã®ãŠé¡Œã¸
                            </button>
                            <button 
                                className="secondary-btn"
                                onClick={() => {
                                    if (ws) ws.close();
                                    setScreen('join');
                                    setGameState(null);
                                }}
                            >
                                ğŸšª é€€å‡º
                            </button>
                        </div>

                        <div className="katakana-checker">
                            <h3>ğŸ“ ã‚«ã‚¿ã‚«ãƒŠãƒã‚§ãƒƒã‚«ãƒ¼</h3>
                            <div className="input-group">
                                <input
                                    type="text"
                                    placeholder="èª¬æ˜æ–‡ã‚’å…¥åŠ›ã—ã¦ãƒã‚§ãƒƒã‚¯"
                                    value={checkText}
                                    onChange={(e) => setCheckText(e.target.value)}
                                />
                            </div>
                            <button onClick={handleCheckKatakana}>
                                ãƒã‚§ãƒƒã‚¯
                            </button>
                            
                            {checkResult && (
                                <div className={`check-result ${checkResult.has_katakana ? 'danger' : 'safe'}`}>
                                    {checkResult.has_katakana 
                                        ? 'âŒ ã‚«ã‚¿ã‚«ãƒŠãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼' 
                                        : 'âœ… ã‚«ã‚¿ã‚«ãƒŠã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ï¼'}
                                </div>
                            )}
                        </div>

                        <div style={{marginTop: '30px'}}>
                            <h3 style={{marginBottom: '10px'}}>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</h3>
                            <div className="chat-area">
                                {chatMessages.map((msg, index) => (
                                    <div key={index} className="chat-message">
                                        <span className="chat-user">{msg.user}:</span>
                                        <span>{msg.message}</span>
                                    </div>
                                ))}
                            </div>
                            <form onSubmit={handleSendChat} style={{marginTop: '10px'}}>
                                <div style={{display: 'flex', gap: '10px'}}>
                                    <input
                                        type="text"
                                        placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
                                        value={chatInput}
                                        onChange={(e) => setChatInput(e.target.value)}
                                        style={{flex: 1}}
                                    />
                                    <button type="submit" style={{width: 'auto', padding: '12px 20px'}}>
                                        é€ä¿¡
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div className="status">
                            {connected ? 'ğŸŸ¢ æ¥ç¶šä¸­' : 'ğŸ”´ åˆ‡æ–­'}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
